[toc]

# 2PC

## 简述

二阶段提交(Two-Phase Commit)，是一个非常经典的**强一致**、**中心化的原子提交协议**。目前，绝大多数关系型数据库都采用二阶段提交协议来完成分布式事务处理（例如mysql的XA协议）。因此二阶段提交协议也被广泛运用到分布式系统中。

顾名思义，算法流程就是分为两个阶段提交某一操作，其分为准备阶段、提交阶段。为了更好描述算法过程，为此定义了两种角色：协调者（Coordinator）、参与者（Participant）。



## 阶段一：准备阶段

准备阶段，又被称为投票阶段（Vote Request），由协调者向参与者发送请求，询问当前事务能否处理成功。参与者则开启本地数据库事务，开始执行数据库操作，但是并不会提交。根据操作结果，返回给协调者“yes/no”，表示事务是否可以提交。

- 事务询问 协调者向所有参与者发送**事务内容**，询问是否可以执行事务的提交操作，并等待各参与者的响应
- 执行事务 各参与者执行事务操作，准备好事务资源，记录undo、redo信息
- 反馈询问结果 如果参与者成功执行了事务操作，那么返回给协调者yes（表示当前事务可以提交），否者返回给协调者no（表示当前事务不能执行）



## 阶段二：提交阶段

在准备阶段，由于参与者可以返回yes/no，则在提交阶段也会出现两种可能，即全局提交事务、全局回滚事务。



### 全局提交事务

当准备阶段所有参与者都返回yes的响应后，协调者将发起全局提交事务请求。

- 发送提交请求 由协调者向所有参与者发送global_commit请求，要求提交当前事务
- 事务提交 当参与者收到global_commit请求后，则执行事务提交操作，并释放整个分布式事务期间占用的事务资源
- 反馈提交结果 参与在执行完事务提交后，向协调者返回ack消息
- 完成事务提交 协调者收到所有参与者反馈的ack消息后，给客户端返回结果，完成本次事务



### 全局回滚事务

当准备阶段有一个参与者都返回no的响应后，或者在协调者等待响应超时后，则协调者将发起全局回滚事务请求，中断事务。

- 发送回滚请求 由协调者向所有参与者发送global_rollback请求，要求中断当前事务
- 事务回滚 当参与者收到global_rollback请求后，会利用准备阶段记录的undo信息来进行回滚，并释放整个分布式事务期间占用的事务资源
- 反馈回滚结果 参与在执行完事务提交后，向协调者返回ack消息
- 中断事务 协调者收到所有参与者反馈的ack消息后，给客户端返回结果，完成中断事务